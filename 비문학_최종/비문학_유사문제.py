# -*- coding: utf-8 -*-
"""ë¹„ë¬¸í•™_ìœ ì‚¬ë¬¸ì œ

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1K63NHRBnQpWe4z5KKk_ffH8dJCXg53eJ

## ê¸°ë³¸ install
"""

from google.colab import drive
drive.mount('/content/drive')

!pip install pytesseract PyPDF2

!pip install pdfplumber pdf2image

# Install Poppler utilities
!sudo apt-get update
!sudo apt-get install -y poppler-utils

import os
os.environ["OPENAI_API_KEY"] = "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"

!pip install faiss-cpu

import os
import base64
from PIL import Image
from IPython.display import display
from openai import OpenAI

"""## GPT íƒœê¹… í”„ë¡¬í”„íŠ¸"""

import os
from openai import OpenAI

client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

tag_prompt = """
ì•„ë˜ëŠ” êµ­ì–´ ì˜ì—­ ë¹„ë¬¸í•™ ë¬¸ì œì…ë‹ˆë‹¤.
ì´ ë¬¸ì œì— ëŒ€í•´ ë‹¤ìŒ ì •ë³´ë¥¼ íƒœê·¸ë¡œ ìƒì„±í•´ ì£¼ì„¸ìš”(ìµœëŒ€ 6ê°œ):
- ì¶œì œ ì˜ì—­(ë¹„ë¬¸í•™)
- ì„¸ë¶€ ë¶„ì•¼(ì¸ë¬¸-ì² í•™/ë…¼ë¦¬/ì–¸ì–´/ì—­ì‚¬, ì‚¬íšŒ-ì •ì¹˜/ë²•/ê²½ì œ/ì‚¬íšŒ/ë¬¸í™”, ê³¼í•™-ë¬¼ë¦¬/í™”í•™/ìƒë¬¼/ì§€êµ¬ê³¼í•™, ê¸°ìˆ -ì»´í“¨í„°/ê¸°ê³„/ì‘ìš©/ì‹¤ìš©, ì˜ˆìˆ -ë¯¸ìˆ /ìŒì•…/ê±´ì¶•/ê³µì—°, ìœµí•©)
- ë¬¸ì œ ìœ í˜•(ë‹¨ì¼ë¬¸ì œ/ë³µí•©ë¬¸ì œ)
- ì£¼ìš” ì£¼ì œ ë˜ëŠ” í‚¤ì›Œë“œ

ì§€ë¬¸ì´ (ê°€), (ë‚˜)ë¡œ ì´ë£¨ì–´ì§€ë©´ ë³µí•©ë¬¸ì œì…ë‹ˆë‹¤.

íƒœê·¸ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„í•´ì„œ ì¶œë ¥í•´ ì£¼ì„¸ìš”.
ì˜ˆ) ë¹„ë¬¸í•™, ì‚¬íšŒ-ê²½ì œ, ë³µí•©ë¬¸ì œ, ê³µê³µì¬, ì •ì±… ë”œë ˆë§ˆ, ì§€ë°© ì •ë¶€ ì¬ì • ì§€ì›

ë¬¸ì œ:
{text}
"""

def generate_tags_from_passage(passage):
    prompt = tag_prompt.format(text=passage)
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": "ë„ˆëŠ” êµ­ì–´ ë¬¸ì œ íƒœê¹… ì „ë¬¸ê°€ì•¼."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.2
    )
    tag_line = response.choices[0].message.content.strip()

    tags = [tag.strip() for tag in tag_line.split(",") if tag.strip()]

    return {
        "passage": passage,
        "genre": tags[1],
        "question_type": "ë³µí•©ë¬¸ì œ" if "ë³µí•©" in tags[2] else "ë‹¨ì¼ë¬¸ì œ",
        "keywords": tags[3:],
    }

"""## ì„ë² ë”© & ìœ ì‚¬ë¬¸ì œ ì¶”ì²œ"""

!pip install easyocr

from sklearn.metrics.pairwise import cosine_similarity
from sentence_transformers import SentenceTransformer
import numpy as np
import json

# 1. ëª¨ë¸ê³¼ ë°ì´í„° ì¤€ë¹„
print("ëª¨ë¸ê³¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
model = SentenceTransformer("jhgan/ko-sroberta-multitask")

with open("/content/drive/MyDrive/STUBO/non-literature_cleaned.json", encoding="utf-8") as f:
    data = json.load(f)

passages = [item["passage"] for item in data]
embeddings = model.encode(passages, convert_to_tensor=False)  # ì „ì²´ ì§€ë¬¸ ì„ë² ë”© (ê³ ì •)

print("ì´ˆê¸°í™” ì™„ë£Œ!")

# 2. ìœ ì‚¬ ë¬¸ì œ ì¶”ì²œ í•¨ìˆ˜ (í‚¤ì›Œë“œ â†’ ì½”ì‚¬ì¸ ìœ ì‚¬ë„)
def recommend_for_external_problem(target_problem, top_n=2):
    target_passage = target_problem["passage"]
    target_keywords = target_problem["keywords"]
    target_type = target_problem["question_type"]
    target_genre = target_problem["genre"]

    # ì§€ë¬¸ ì„ë² ë”©
    target_embedding = model.encode(target_passage, convert_to_tensor=False)
    passage_similarities = cosine_similarity([target_embedding], embeddings)[0]

    # í‚¤ì›Œë“œ ë¬¸ìì—´ ì„ë² ë”©
    target_kw_string = " ".join(target_keywords)
    target_kw_embedding = model.encode(target_kw_string, convert_to_tensor=False)

    results = []
    for idx, item in enumerate(data):
        # í•„í„° 1: ë¬¸ì œ ì¥ë¥´ ì¼ì¹˜
        if item["genre"] != target_genre:
            continue

        # í•„í„° 2: í‚¤ì›Œë“œ ìœ ì‚¬ë„
        item_kw_string = " ".join(item["keywords"])
        item_kw_embedding = model.encode(item_kw_string, convert_to_tensor=False)
        keyword_sim = cosine_similarity([target_kw_embedding], [item_kw_embedding])[0][0]

        # í•„í„° 3: ì§€ë¬¸ ìœ ì‚¬ë„
        passage_sim = passage_similarities[idx]

        # ê¸°ë³¸ ì ìˆ˜ ê³„ì‚°
        final_score = 0.5 * keyword_sim + 0.5 * passage_sim

        # ğŸ”¹ ë³´ì • ì ìˆ˜ ì¶”ê°€: ë¬¸ì œ ìœ í˜•ì´ ì¼ì¹˜í•˜ë©´
        if item["question_type"] == target_type:
            final_score += 0.2

        # ê²°ê³¼ ì €ì¥
        results.append({
            "year": item["year"],
            "month": item["month"],
            "pNum": item["pNum"],
            "start_Qnum": item.get("start_Qnum"),
            "end_Qnum": item.get("end_Qnum"),
            "score": round(final_score, 4),
            "keyword_cosine": round(keyword_sim, 4),
            "embedding_sim": round(passage_sim, 4),
            "preview": item["passage"][:100]
        })

    results = sorted(results, key=lambda x: x["score"], reverse=True)[:top_n]
    return results

# STEP 1: GPTë¡œ íƒœê¹…
def tag_from_image(image_path):
    with open(image_path, "rb") as image_file:
        base64_image = base64.b64encode(image_file.read()).decode("utf-8")

    client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": "ë„ˆëŠ” êµ­ì–´ ë¬¸ì œ íƒœê¹… ì „ë¬¸ê°€ì•¼."},
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": "ì´ êµ­ì–´ ì§€ë¬¸ ì´ë¯¸ì§€ë¥¼ ë³´ê³ , ì•„ë˜ ê¸°ì¤€ì— ë”°ë¼ íƒœê·¸ë¥¼ ìƒì„±í•´ ì¤˜:\n" + tag_prompt +
                       """ \n ì§€ë¬¸ ë¶„ëŸ‰ê³¼ í‚¤ì›Œë“œì™€ ìƒê´€ ì—†ì´ (ê°€), (ë‚˜) ë“±ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ìˆì§€ ì•Šìœ¼ë©´ ë¬´ì¡°ê±´ ë‹¨ì¼ ë¬¸ì œì•¼.
                          ê·¸ë¦¬ê³  ì—¬ê¸° ì•ˆì—ì„œ ì¥ë¥´ë¥¼ ë¶„ë¥˜í•´ì¤˜('ì¸ë¬¸-ì–¸ì–´', 'ì¸ë¬¸-ì² í•™', 'ì‚¬íšŒ-ê²½ì œ', 'ê¸°ìˆ -ì»´í“¨í„°', 'ì‚¬íšŒ-ë²•', 'ê³¼í•™-ìƒë¬¼', 'ì¸ë¬¸-ì—­ì‚¬', 'ê³¼í•™-í™”í•™', 'ì¸ë¬¸-ì‹¬ë¦¬', 'ì˜ˆìˆ -ë¯¸ìˆ ', 'ê³¼í•™-ë¬¼ë¦¬', 'ì‚¬íšŒ-ì •ì¹˜', 'ì˜ˆìˆ -ìŒì•…', 'ì˜ˆìˆ -ì˜í™”')"""},
                    {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}}
                ]
            }
        ],
        temperature=0.2
    )

    tags = response.choices[0].message.content.strip().split(",")
    tags = [t.strip() for t in tags if t.strip()]

    #print("\n[ìë™ íƒœê¹… ê²°ê³¼]")
    #print("GPT ì‘ë‹µ:", ", ".join(tags))

    return {
        "passage": "[ì´ë¯¸ì§€ ê¸°ë°˜ ì§€ë¬¸ ìƒëµ]",
        "genre": tags[1],
        "question_type": "ë³µí•©ë¬¸ì œ" if "ë³µí•©" in tags[2] else "ë‹¨ì¼ë¬¸ì œ",
        "keywords": tags[2:-1],  # ë¬¸ì œë²ˆí˜¸ ì œì™¸
    }

import os
from PIL import Image
from IPython.display import display

def show_problem_image_set(similar_problems, image_base="/content/drive/MyDrive/classified_images/ë¹„ë¬¸í•™"):
    for i, p in enumerate(similar_problems, 1):
        year = p.get('year', 'ì •ë³´ ì—†ìŒ')
        month = p.get('month', 'ì •ë³´ ì—†ìŒ')
        pNum = p.get('pNum', 'ì •ë³´ ì—†ìŒ')
        start_Q = p.get('start_Qnum', None)
        end_Q = p.get('end_Qnum', None)

        print(f"\n--- ìœ ì‚¬ ë¬¸ì œ {i} ---")
        print("\n")
        print(f"{year}-{month}")
        img_filename = f"{year}-{month}-êµ­ì–´_p{pNum}.png"
        img_path = os.path.join(image_base, img_filename)
        img = Image.open(img_path)
        display(img)

        if year == 'ì •ë³´ ì—†ìŒ' or month == 'ì •ë³´ ì—†ìŒ' or start_Q is None or end_Q is None:
            print("[ê²½ê³ ] start_Qnum ë˜ëŠ” end_Qnum ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì¶œë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            continue

        for q_num in range(start_Q, end_Q + 1):
            image_filename = f"{year}-{month}-êµ­ì–´_{q_num}.png"
            image_path = os.path.join(image_base, image_filename)

            #print(f"[ë¬¸ì œ {q_num}] ì´ë¯¸ì§€ íŒŒì¼: {image_filename}", end=' ')
            if os.path.exists(image_path):
                #print("â†’ ì¡´ì¬")
                image = Image.open(image_path)
                display(image)
                print("\n")
            #else:
                #print("â†’ ì—†ìŒ (íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ)")

import os

# 1. í…ŒìŠ¤íŠ¸í•  ì´ë¯¸ì§€ íŒŒì¼ëª…
image_name = "1_á„ƒá…¡á†«á„‹á…µá†¯_á„ƒá…©á†¼á„’á…§á†¼á„‹á…µá„‹á…´á„‹á…¥.png"

# 2. í´ë” ê²½ë¡œ
folder_path = "/content/drive/MyDrive/á„‹á…²á„‰á…¡test"
image_path = os.path.join(folder_path, image_name)

# 3. ì¡´ì¬ ì—¬ë¶€ í™•ì¸
if not os.path.exists(image_path):
    print(f"âŒ ì´ë¯¸ì§€ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {image_path}")
else:
    print(f"\n=== ì´ë¯¸ì§€: {image_name} ===")
    img = Image.open(image_path)
    display(img)

    # 4. GPT Visionìœ¼ë¡œ íƒœê¹…
    external_problem = tag_from_image(image_path)

    # 5. ìœ ì‚¬ ë¬¸ì œ ì¶”ì²œ
    print("\n\n[ìœ ì‚¬ ë¬¸ì œ ì¶”ì²œ ê²°ê³¼]")
    similar_problems = recommend_for_external_problem(external_problem)

    # 6. ì¶”ì²œëœ ë¬¸ì œ ì´ë¯¸ì§€ í‘œì‹œ
    if similar_problems:
        show_problem_image_set(similar_problems)
    else:
        print("ìµœê·¼ì— ì¶œì œëœ ìœ ì‚¬í•œ ê¸°ì¶œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.")